-   Title: analysis_en03
-   Version: 0.3.1
-   Last edit: 2022/09/02

## In case you need a clean start:

```{r}
rm(list=ls())
```

## Load some packages.

```{r include = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(languageR)
library(dplyr)
library(tidyr)
library(lme4)
library(datasets)
library(ggpubr)
library(rstatix)
library(broom)
library(car)
library(forcats)
```

## Data preparation.

-   Load data (utf8_220706_EN03_results.csv). Redo if source file changed.
-   Make sure it's UTF-8!!!

```{r}
# load data. redo if source file changed. 
en03_results <- read.csv(file.choose(), 
                         header = TRUE, 
                         na.strings = "NA",
                         encoding = "UTF-8")
```

-   Check data.

```{r}
# open a panel to check the data file
View(en03_results)

# check summary of data
summary(en03_results)
```

-   Reorder factor level of target sounds.

```{r}
en03_results_new <- en03_results

# factor() converts a variable into a factor variable
# with the c() argument, it can also reorder factor level
# "p t k b d g" in this case
en03_results_new$target.sound <- factor(en03_results_new$target.sound,
                                        c("p", "t", "k", "b", "d", "g")
                                        )
en03_results_new$prev.sound.type <- factor(en03_results_new$prev.sound.type,
                                        c("vowel", "approximant", "appro/vow", "nasal", "consonant")
                                        )

```

-   Check dispersion & write into a file.

```{r}
# check dispersion of data. remember to REMOVE NA VALUES!!!
dispersion_en03 <- en03_results_new %>% 
  group_by(target.sound) %>%  
  summarise(mean_clo = mean(duration_CLO, na.rm = TRUE),
            sd_clo = sd(duration_CLO, na.rm = TRUE),
            mean_bur = mean(duration_BUR, na.rm = TRUE),
            sd_bur = sd(duration_BUR, na.rm = TRUE),
            mean_voi = mean(duration_VOI, na.rm = TRUE),
            sd_voi = sd(duration_VOI, na.rm = TRUE),
            mean_voiclo = mean(VOI.CLO, na.rm = TRUE),
            sd_voiclo = sd(VOI.CLO, na.rm = TRUE)
            )

# open a panel to check the dispersion table
View(dispersion_en03)

# export dispersion table to a csv file
write.csv(dispersion_en03, 
          "C:/Users/***/Desktop/R_working_dir/analysis_en03/dispersion_en03.csv",
          row.names = TRUE)

```

## Plotting

-   (base R) Make some quick box plots to check possible correlation.

```{r}
boxplot(VOI.CLO ~ target.sound, 
                            data = en03_results_new,
                            main = "dispersion of VOI/CLO value",
                            xlab = "target sound",
                            ylab = "VOI/CLO"
                            )

```

-   (forcats) Collapse factor levels into manually defined groups

```{r}
library(forcats)

en03_results_new$target.sound2 <- fct_collapse(en03_results_new$target.sound, 
                                               voiceless = c("p", "t", "k"), 
                                               voiced = c("b", "d", "g")
                                               )
en03_results_new$target.sound2 <- factor(en03_results_new$target.sound2,
                                        c("voiceless", "voiced")
                                        )

View(en03_results_new) 
# A new column "target.sound2" is now added to the dataframe.

```

-   Using the new column as grouping factor to make a new dispersion table.

```{r}
dispersion2_en03 <- en03_results_new %>% 
  group_by(target.sound2) %>%  
  summarise(mean_clo = mean(duration_CLO, na.rm = TRUE),
            sd_clo = sd(duration_CLO, na.rm = TRUE),
            mean_bur = mean(duration_BUR, na.rm = TRUE),
            sd_bur = sd(duration_BUR, na.rm = TRUE),
            mean_voi = mean(duration_VOI, na.rm = TRUE),
            sd_voi = sd(duration_VOI, na.rm = TRUE),
            mean_voiclo = mean(VOI.CLO, na.rm = TRUE),
            sd_voiclo = sd(VOI.CLO, na.rm = TRUE)
            )

# open a panel to check the dispersion table
View(dispersion2_en03)

# export dispersion table to a csv file
write.csv(dispersion2_en03, 
          "C:/Users/***/Desktop/R_working_dir/analysis_en03/dispersion2_en03.csv",
          row.names = TRUE)

```

-   (ggplot2) Make box plots to check dispersion for duration of closure.
-   With variable box width to display sample size for each group.
-   The newly added factor "target.sound2" can be used for x-axis.

```{r}
# prepare a special xlab with the number of obs for each group
xlab_withN <- paste(levels(en03_results_new$target.sound2),
                    "\n(N=", 
                    table(en03_results_new$target.sound2),
                    ")", 
                    sep="")

box_clo <- ggplot(en03_results_new, aes(x = target.sound2, y = duration_CLO, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of closure duration", x = "Target sound", y = "Duration (sec)") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN)

ggsave("box_clo.png") 
# ggplot() only saves the latest plot, so attach it right after a plot is created.

box_clo


box_bur <- ggplot(en03_results_new, aes(x = target.sound2, y = duration_BUR, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of burst duration", x = "Target sound", y = "Duration (sec)") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN)

ggsave("box_bur.png")

box_bur


box_voi <- ggplot(en03_results_new, aes(x = target.sound2, y = duration_VOI, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of voicing duration", x = "Target sound", y = "Duration (sec)") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN)

ggsave("box_voi.png")

box_voi


box_voiclo <- ggplot(en03_results_new, aes(x = target.sound2, y = VOI.CLO, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of VOI/CLO values", x = "Target sound", y = "VOI/CLO") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN)

ggsave("box_voiclo.png")

box_voiclo

```

-   Take a closer look at INTERVOCALIC targets.

```{r}
# Create a sub data frame.
en03_intervocalic <- en03_results_new[en03_results_new$prev.sound.type != 'consonant' & en03_results_new$following.sound.type != 'consonant',]

library(forcats)

en03_intervocalic$target.sound2 <- fct_collapse(en03_intervocalic$target.sound, 
                                               voiceless = c("p", "t", "k"), 
                                               voiced = c("b", "d", "g")
                                               )
en03_intervocalic$target.sound2 <- factor(en03_intervocalic$target.sound2,
                                        c("voiceless", "voiced")
                                        )

View(en03_intervocalic)

```

```{r}
dispersion_en03_intervocalic <- en03_intervocalic %>% 
  group_by(target.sound2) %>%  
  summarise(mean_clo = mean(duration_CLO, na.rm = TRUE),
            sd_clo = sd(duration_CLO, na.rm = TRUE),
            mean_bur = mean(duration_BUR, na.rm = TRUE),
            sd_bur = sd(duration_BUR, na.rm = TRUE),
            mean_voi = mean(duration_VOI, na.rm = TRUE),
            sd_voi = sd(duration_VOI, na.rm = TRUE),
            mean_voiclo = mean(VOI.CLO, na.rm = TRUE),
            sd_voiclo = sd(VOI.CLO, na.rm = TRUE)
            )

View(dispersion_en03_intervocalic)

write.csv(dispersion_en03_intervocalic, 
          "C:/Users/***/Desktop/R_working_dir/analysis_en03/dispersion_en03_intervocalic.csv",
          row.names = TRUE)
```

-   Box plots for intervocalic targets.

```{r}
xlab_withN_intervocalic <- paste(levels(en03_intervocalic$target.sound2),
                    "\n(N=", 
                    table(en03_intervocalic$target.sound2),
                    ")", 
                    sep="")

box_clo_intervocalic <- ggplot(en03_intervocalic, aes(x = target.sound2, y = duration_CLO, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of closure duration", x = "Target sound", y = "Duration (sec)") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN_intervocalic)


box_clo_intervocalic

ggsave("box_clo_intervocalic.png") 
# ggsave() only saves the latest plot, so attach it right after a plot is created.

box_bur_intervocalic <- ggplot(en03_intervocalic, aes(x = target.sound2, y = duration_BUR, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of burst duration", x = "Target sound", y = "Duration (sec)") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN_intervocalic)

box_bur_intervocalic

ggsave("box_bur_intervocalic.png") 


box_voi_intervocalic <- ggplot(en03_intervocalic, aes(x = target.sound2, y = duration_VOI, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of voicing duration", x = "Target sound", y = "Duration (sec)") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN_intervocalic)

box_voi_intervocalic

ggsave("box_voi_intervocalic.png") 

box_voiclo_intervocalic <- ggplot(en03_intervocalic, aes(x = target.sound2, y = VOI.CLO, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of VOI/CLO values", x = "Target sound", y = "VOI/CLO") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN_intervocalic)

box_voiclo_intervocalic

ggsave("box_voiclo_intervocalic.png") 

```

## Add other factors into the picture. One at a time.
-   Note: use the whole data set ftm.
-   Factor 1: target syllable stress.

```{r}
box_clo_stress <- ggplot(en03_results_new, aes(x = target.sound2, y = duration_CLO, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of closure duration (unstressed vs stressed)", x = "Target sound", y = "Duration (sec)") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN)

# adding one factor into the picture.
box_clo_stress <- box_clo_stress + facet_wrap(~ target.syllable.stress)

box_clo_stress

ggsave("box_clo_stress.png") 
# ggsave() only saves the latest plot, so do it right after a plot is created.

```

-   Factor 2: at morpheme boundary.

```{r}
box_clo_boundary <- ggplot(en03_results_new, aes(x = target.sound2, y = duration_CLO, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of closure duration (at morpheme boundary?)", x = "Target sound", y = "Duration (sec)") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN)

box_clo_boundary <- box_clo_boundary + facet_wrap(~ at.morpheme.boundary)

box_clo_boundary

ggsave("box_clo_boundary.png") 

```

## Maybe later?

-   Make stacked bar plots to show target sound contextual info.

```{r}

```

-   LME attempts.
-   Syntax: model = lmer(target \~ fixed1 + fixed2 + (1\|random1) + (1\|random2), data=data)
-   Still need: interpretation, data from multiple speakers (for random effects controlling etc.)

```{r}
model_voiclo1 = lmer(duration_BUR ~ target.sound2 + (1|target.word), data = en03_results_new)
summary(model_voiclo1)
```
