-   Title: analysis_en03
-   Version: 0.3.2
-   Last edit: 2022/09/03

## In case you need a clean start:

```{r}
rm(list=ls())
```

## Load some packages.

```{r include = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(languageR)
library(dplyr)
library(tidyr)
library(lme4)
library(datasets)
library(ggpubr)
library(rstatix)
library(broom)
library(car)
library(forcats)
```

## Data preparation.

-   Load data. Redo if source file changed.
-   Make sure it's UTF-8!!!

```{r}
# load data. redo if source file changed. 
en03_results <- read.csv(file.choose(), 
                         header = TRUE, 
                         na.strings = "NA",
                         encoding = "UTF-8")
```

-   Check data.

```{r}
# open a panel to check the data file
View(en03_results)

# check summary of data
summary(en03_results)

```

-   Reorder factor level of target sounds.

```{r}
en03_results_new <- en03_results

# factor() converts a variable into a factor variable
# with the c() argument, it can also reorder factor level
# "p t k b d g" in this case
en03_results_new$target_sound <- factor(en03_results_new$target_sound,
                                        c("p", "t", "k", "b", "d", "g")
                                        )
en03_results_new$pre_s_type <- factor(en03_results_new$pre_s_type,
                                        )

```

-   Check dispersion & write into a file.

```{r}
# check dispersion of data. remember to REMOVE NA VALUES!!!
dispersion_en03 <- en03_results_new %>% 
  group_by(target_sound) %>%  
  summarise(mean_clo = mean(closure_dur, na.rm = TRUE),
            sd_clo = sd(closure_dur, na.rm = TRUE),
            mean_bur = mean(burst_dur, na.rm = TRUE),
            sd_bur = sd(burst_dur, na.rm = TRUE),
            mean_voi = mean(voicing_dur, na.rm = TRUE),
            sd_voi = sd(voicing_dur, na.rm = TRUE),
            mean_voiclo = mean(VOI.CLO, na.rm = TRUE),
            sd_voiclo = sd(VOI.CLO, na.rm = TRUE)
            )

# open a panel to check the dispersion table
View(dispersion_en03)

# export dispersion table to a csv file
write.csv(dispersion_en03, 
          "C:/Users/***/Desktop/R_working_dir/analysis_en03/dispersion_en03.csv",
          row.names = TRUE)

```

## Plotting

-   (base R) Make some quick box plots to check possible correlation.

```{r}
boxplot(VOI.CLO ~ target_sound, 
                            data = en03_results_new,
                            main = "dispersion of VOI/CLO value",
                            xlab = "target sound",
                            ylab = "VOI/CLO"
                            )

```

-   (forcats) Collapse factor levels into manually defined groups

```{r}
library(forcats)
en03_results_new$target_sound2 <- fct_collapse(en03_results_new$target_sound, 
                                               voiceless = c("p", "t", "k"), 
                                               voiced = c("b", "d", "g")
                                               )
en03_results_new$target_sound2 <- factor(en03_results_new$target_sound2,
                                        c("voiceless", "voiced")
                                        )

View(en03_results_new) 
# A new column "target.sound2" is now added to the dataframe.

```

-   Using the new column as grouping factor to make a new dispersion table.

```{r}
dispersion_en03_new <- en03_results_new %>% 
  group_by(target_sound2) %>%  
  summarise(mean_clo = mean(closure_dur, na.rm = TRUE),
            sd_clo = sd(closure_dur, na.rm = TRUE),
            mean_bur = mean(burst_dur, na.rm = TRUE),
            sd_bur = sd(burst_dur, na.rm = TRUE),
            mean_voi = mean(voicing_dur, na.rm = TRUE),
            sd_voi = sd(voicing_dur, na.rm = TRUE),
            mean_voiclo = mean(VOI.CLO, na.rm = TRUE),
            sd_voiclo = sd(VOI.CLO, na.rm = TRUE)
            )

# open a panel to check the dispersion table
View(dispersion_en03_new)

# export dispersion table to a csv file
write.csv(dispersion_en03_new, 
          "C:/Users/***/Desktop/R_working_dir/analysis_en03/dispersion_en03_new.csv",
          row.names = TRUE)

```

-   (ggplot2) Make box plots to check dispersion for duration of closure.
-   With variable box width to display sample size for each group.
-   The newly added factor "target_sound2" can be used for x-axis.

```{r}
# prepare a special xlab with the number of obs for each group
xlab_withN <- paste(levels(en03_results_new$target_sound2),
                    "\n(N=", 
                    table(en03_results_new$target_sound2),
                    ")", 
                    sep="")

box_clo <- ggplot(en03_results_new, aes(x = target_sound2, y = closure_dur, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of closure duration", x = "Target sound", y = "Duration (sec)") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN)

ggsave("box_clo.png") 
# ggplot() only saves the latest plot, so attach it right after a plot is created.

box_clo


box_bur <- ggplot(en03_results_new, aes(x = target_sound2, y = burst_dur, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of burst duration", x = "Target sound", y = "Duration (sec)") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN)

ggsave("box_bur.png")

box_bur


box_voi <- ggplot(en03_results_new, aes(x = target_sound2, y = voicing_dur, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of voicing duration", x = "Target sound", y = "Duration (sec)") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN)

ggsave("box_voi.png")

box_voi


box_voiclo <- ggplot(en03_results_new, aes(x = target_sound2, y = VOI.CLO, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of VOI/CLO values", x = "Target sound", y = "VOI/CLO") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN)

ggsave("box_voiclo.png")

box_voiclo

```

-   Take a closer look at INTERSONORANT targets.

```{r}
# Create a subset for intersonorant targets
library(forcats)
en03_results_new$pre_s_type2 <- fct_collapse(en03_results_new$pre_s_type, 
                                               obstruent = c("fric", "stop"), 
                                               sonorant = c("lat", "nas", "vowel","vowel_hi")
                                               )

en03_results_new$foll_s_type2 <- fct_collapse(en03_results_new$foll_s_type, 
                                               obstruent = c("fric", "stop"), 
                                               sonorant = c("lat", "nas", "vowel","vowel_hi", "gli", "rho")
                                               )

en03_intersonorant<- en03_results_new[en03_results_new$pre_s_type2 == "sonorant" & en03_results_new$foll_s_type2 == "sonorant",]

View(en03_intersonorant)

```

```{r}
dispersion_en03_intersonorant <- en03_intersonorant %>% 
  group_by(target_sound2) %>%  
  summarise(mean_clo = mean(closure_dur, na.rm = TRUE),
            sd_clo = sd(closure_dur, na.rm = TRUE),
            mean_bur = mean(burst_dur, na.rm = TRUE),
            sd_bur = sd(burst_dur, na.rm = TRUE),
            mean_voi = mean(voicing_dur, na.rm = TRUE),
            sd_voi = sd(voicing_dur, na.rm = TRUE),
            mean_voiclo = mean(VOI.CLO, na.rm = TRUE),
            sd_voiclo = sd(VOI.CLO, na.rm = TRUE)
            )

View(dispersion_en03_intersonorant)

write.csv(dispersion_en03_intersonorant, 
          "C:/Users/***/Desktop/R_working_dir/analysis_en03/dispersion_en03_intersonorant.csv",
          row.names = TRUE)
```

-   Box plots for intersonorant targets.

```{r}
xlab_withN_intersonorant <- paste(levels(en03_intersonorant$target_sound2),
                    "\n(N=", 
                    table(en03_intersonorant$target_sound2),
                    ")", 
                    sep="")

box_clo_intersonorant <- ggplot(en03_intersonorant, aes(x = target_sound2, y = closure_dur, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of closure duration", x = "Target sound", y = "Duration (sec)") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN_intersonorant)


box_clo_intersonorant

ggsave("box_clo_intersonorant.png") 
# ggsave() only saves the latest plot, so attach it right after a plot is created.

```

```{r}
box_bur_intersonorant <- ggplot(en03_intersonorant, aes(x = target_sound2, y = burst_dur, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of burst duration", x = "Target sound", y = "Duration (sec)") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN_intersonorant)

box_bur_intersonorant

ggsave("box_bur_intersonorant.png") 


box_voi_intersonorant <- ggplot(en03_intersonorant, aes(x = target_sound2, y = voicing_dur, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of voicing duration", x = "Target sound", y = "Duration (sec)") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN_intersonorant)

box_voi_intersonorant

ggsave("box_voi_intersonorant.png") 

box_voiclo_intersonorant <- ggplot(en03_intersonorant, aes(x = target_sound2, y = VOI.CLO, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of VOI/CLO values", x = "Target sound", y = "VOI/CLO") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN_intersonorant)

box_voiclo_intersonorant

ggsave("box_voiclo_intersonorant.png") 

```

## Add other factors into the picture. One at a time.
-   Note: use the whole data set ftm.
-   Factor 1: target syllable stress.

```{r}
box_clo_stress <- ggplot(en03_results_new, aes(x = target_sound2, y = closure_dur, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of closure duration (unstressed vs stressed)", x = "Target sound", y = "Duration (sec)") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN)

# adding one factor into the picture.
box_clo_stress <- box_clo_stress + facet_wrap(~ stressed)

box_clo_stress

ggsave("box_clo_stress.png") 
# ggsave() only saves the latest plot, so do it right after a plot is created.

```

-   Factor 2: at morpheme boundary.

```{r}
box_clo_boundary <- ggplot(en03_results_new, aes(x = target_sound2, y = closure_dur, na.rm = TRUE)) + 
  stat_boxplot(geom = "errorbar", width = 0.25, na.rm = TRUE) + 
  geom_boxplot(varwidth = TRUE, fill = "gray", na.rm = TRUE) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "black", na.rm = TRUE) +
  labs(title = "Dispersion of closure duration (at morpheme boundary?)", x = "Target sound", y = "Duration (sec)") + 
  theme(legend.position = "none") + 
  scale_x_discrete(labels = xlab_withN)

box_clo_boundary <- box_clo_boundary + facet_wrap(~ boundary)

box_clo_boundary

ggsave("box_clo_boundary.png") 

```

## Maybe later?

-   Make stacked bar plots to show target sound contextual info.

```{r}

```

-   LME attempts.
-   Syntax: model = lmer(target \~ fixed1 + fixed2 + (1\|random1) + (1\|random2), data=data)
-   Still need: interpretation, data from multiple speakers (for random effects controlling etc.)

```{r}
model_voiclo1 = lmer(duration_BUR ~ target.sound2 + (1|target.word), data = en03_results_new)
summary(model_voiclo1)
```
